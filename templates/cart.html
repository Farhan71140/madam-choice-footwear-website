<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Madam Choice - Cart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">

  <!-- Cart Section -->
  <div id="cartSection">
    <h2 class="mb-4">Your Cart</h2>

    <div id="cartItems" class="mb-3">
      <p>PureGoldSoftMaroon × 1 – ₹480</p>
      <p>PinkStoneFlat × 1 – ₹200</p>
      <p>airparkgreyS × 1 – ₹450</p>
      <p>airparkonionS × 1 – ₹450</p>
      <p>vanshipurpleS × 2 – ₹1300</p>
    </div>

    <p class="fw-bold">Total: <span id="cartTotalDisplay">₹2880.00</span></p>

    <!-- Buy Now Button -->
    <button class="btn btn-primary" onclick="showPayment()">Buy Now</button>
  </div>

  <!-- Payment Section (hidden initially) -->
  <div id="paymentSection" class="d-none">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h5 class="fw-bold mb-0">Complete Your Payment</h5>
      <button class="btn btn-outline-secondary btn-sm" onclick="showCart()">← Back to Cart</button>
    </div>

    <p class="mb-3">
      Original Amount: ₹<span id="originalAmount" style="text-decoration: line-through; color: red;"></span><br>
      <span class="fw-bold">Payable Amount: ₹<span id="paymentAmount"></span></span>
    </p>

    <div class="mb-3">
      <label for="coupon" class="form-label">Apply Coupon</label>
      <input type="text" id="coupon" class="form-control" placeholder="Enter coupon code e.g. madamchoice10">
      <button class="btn btn-primary mt-2" onclick="applyCoupon()">Apply Coupon</button>
      <p id="discountInfo" class="mt-2 fw-bold"></p>
    </div>

    <div class="mb-3">
      <p>Scan QR Code to Pay (Father’s UPI)</p>
      <img src="{{ url_for('static', path='/images/payment-qr.png') }}" alt="QR Code" width="200" height="200">
    </div>

    <div class="mb-3">
      <label for="upiRef" class="form-label">Enter UPI Reference ID</label>
      <input type="text" id="upiRef" class="form-control" placeholder="e.g. 1234567890">
    </div>

    <div class="mb-3">
      <label for="txnId" class="form-label">Enter Transaction ID</label>
      <input type="text" id="txnId" class="form-control" placeholder="e.g. TXN123456">
    </div>

    <button class="btn btn-success mt-3" onclick="confirmCartPayment()">✅ I Have Paid</button>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let cartTotal = 2880; // Example total

    // Show payment section, hide cart
    function showPayment() {
      document.getElementById('cartSection').classList.add('d-none');
      document.getElementById('paymentSection').classList.remove('d-none');

      // Set payable amount
      document.getElementById('paymentAmount').innerText = cartTotal.toFixed(2);
      document.getElementById('originalAmount').innerText = '';
      document.getElementById('discountInfo').innerText = '';
    }

    // Back to cart
    function showCart() {
      document.getElementById('paymentSection').classList.add('d-none');
      document.getElementById('cartSection').classList.remove('d-none');
    }

    // Apply coupon
    async function applyCoupon() {
      const totalText = document.getElementById('paymentAmount').innerText;
      const totalAmount = parseFloat(totalText.replace('₹', '').trim());
      const coupon = document.getElementById('coupon').value.trim();
      const discountInfoEl = document.getElementById('discountInfo');

      if (isNaN(totalAmount) || !coupon) {
        discountInfoEl.innerText = 'Missing total or coupon.';
        discountInfoEl.classList.add('text-danger');
        return;
      }

      const formData = new URLSearchParams();
      formData.append('total_amount', totalAmount);
      formData.append('coupon', coupon);

      try {
        const response = await fetch('/apply-coupon', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: formData
        });

        if (!response.ok) {
          discountInfoEl.innerText = 'Coupon failed.';
          discountInfoEl.classList.add('text-danger');
          return;
        }

        const result = await response.json();
        if (result.discount_percent > 0) {
          document.getElementById('originalAmount').innerText = totalAmount.toFixed(2);
          document.getElementById('paymentAmount').innerText = result.discounted_total.toFixed(2);
          discountInfoEl.innerText = `Coupon Applied: ${result.discount_percent}% off. You saved ₹${(totalAmount - result.discounted_total).toFixed(2)}!`;
          discountInfoEl.classList.remove('text-danger');
          discountInfoEl.classList.add('text-success');
        } else {
          discountInfoEl.innerText = 'Invalid coupon code.';
          discountInfoEl.classList.remove('text-success');
          discountInfoEl.classList.add('text-danger');
        }
      } catch (e) {
        discountInfoEl.innerText = 'Coupon failed.';
        discountInfoEl.classList.add('text-danger');
      }
    }

    // Confirm payment
    function confirmCartPayment() {
      alert('Payment confirmed. Thank you!');
    }
  </script>
</body>
</html>